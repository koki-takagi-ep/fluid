# 計算格子と数値流束

本ドキュメントでは、CFDで用いられる計算格子の種類と数値流束の関係について解説する。

## 目次

1. [計算格子の種類](#1-計算格子の種類)
2. [非圧縮性流体とスタガード格子](#2-非圧縮性流体とスタガード格子)
3. [圧縮性流体と数値流束](#3-圧縮性流体と数値流束)
4. [スキームの適用可能性](#4-スキームの適用可能性)
5. [将来の拡張に向けて](#5-将来の拡張に向けて)

---

## 1. 計算格子の種類

CFDでは主に2種類の変数配置が用いられる。

### 1.1 コロケート格子（Collocated Grid）

全ての物理量（速度、圧力、密度など）を同一の格子点に配置する。

```
    +-------+-------+
    |       |       |
    | (u,v,p) (u,v,p)
    |       |       |
    +-------+-------+
    |       |       |
    | (u,v,p) (u,v,p)
    |       |       |
    +-------+-------+
```

**特徴**:
- 実装が単純
- 境界条件の適用が容易
- 圧縮性流体で標準的に使用

**問題点**:
- 非圧縮性流体で圧力のチェッカーボード振動が発生
- Rhie-Chow補間などの追加処理が必要

### 1.2 スタガード格子（Staggered Grid / MAC格子）

変数を異なる位置に配置する。

```
        v[i,j]
          |
    ------+------
    |            |
u[i-1,j]  p[i,j]  u[i,j]
    |            |
    ------+------
        v[i,j-1]
```

- **圧力**: セル中心
- **u速度**: セル左右の面
- **v速度**: セル上下の面

**特徴**:
- 圧力振動を自然に抑制
- 連続の式の離散化が正確
- 非圧縮性流体で標準的に使用

**問題点**:
- 実装が複雑
- 異なる位置の値を参照するため補間が必要

---

## 2. 非圧縮性流体とスタガード格子

### 2.1 なぜスタガード格子が適しているか

非圧縮性流体では、連続の式：

$$
\nabla \cdot \mathbf{u} = \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y} = 0
$$

これは「拘束条件」であり、速度場を直接制約する。圧力はこの条件を満たすためのLagrange乗数の役割を持つ。

スタガード格子では：
- $u_{i,j}$ と $u_{i-1,j}$ がセルの左右面にある
- 発散の計算 $\frac{u_{i,j} - u_{i-1,j}}{\Delta x}$ がセル中心で自然に定義される
- 圧力もセル中心にあるため、圧力Poisson方程式との整合性が高い

### 2.2 コロケート格子の問題

コロケート格子で同様の発散を計算すると：

$$
\frac{u_{i+1} - u_{i-1}}{2\Delta x}
$$

これは1点飛ばしの差分となり、隣接点の圧力情報を見逃す。結果として、圧力場が「偶数点」と「奇数点」で独立に振動する（チェッカーボード振動）。

---

## 3. 圧縮性流体と数値流束

### 3.1 保存則形式

圧縮性流体では、質量・運動量・エネルギーの保存則を統一的に扱う：

$$
\frac{\partial \mathbf{U}}{\partial t} + \frac{\partial \mathbf{F}}{\partial x} + \frac{\partial \mathbf{G}}{\partial y} = 0
$$

ここで：
$$
\mathbf{U} = \begin{pmatrix} \rho \\ \rho u \\ \rho v \\ E \end{pmatrix}, \quad
\mathbf{F} = \begin{pmatrix} \rho u \\ \rho u^2 + p \\ \rho uv \\ (E+p)u \end{pmatrix}
$$

### 3.2 有限体積法と数値流束

有限体積法では、各セルで保存量の時間発展を計算：

$$
\frac{d\mathbf{U}_i}{dt} = -\frac{\hat{\mathbf{F}}_{i+1/2} - \hat{\mathbf{F}}_{i-1/2}}{\Delta x}
$$

ここで $\hat{\mathbf{F}}_{i+1/2}$ は**数値流束**（numerical flux）であり、隣接セルの情報から近似的に計算される。

### 3.3 Riemann問題

セル境界での状態は不連続になりうる。この不連続面を含む問題を**Riemann問題**と呼び、その解析解または近似解を用いて数値流束を計算する。

代表的なリーマンソルバー：
- **Exact Riemann solver**: 厳密解（計算コスト高）
- **Roe solver**: 線形化されたRiemann問題
- **HLL/HLLC**: 波速推定に基づく近似
- **Rusanov (Local Lax-Friedrichs)**: 最も単純で頑健

### 3.4 高次精度再構築

数値流束の精度を上げるため、セル境界での値を高次精度で再構築する：

- **MUSCL**: 勾配制限付き線形再構築（TVD）
- **ENO**: 滑らかさに基づくステンシル選択
- **WENO**: ENOの重み付き平均

---

## 4. スキームの適用可能性

### 4.1 本ソルバーでの適用

| スキーム | スタガード格子での適用 | 適用対象 |
|---------|---------------------|---------|
| 1次風上 | ○ | 移流項 $\mathbf{u} \cdot \nabla u$ |
| TVD (Minmod等) | ○ | 移流項（本実装） |
| 中心差分 | ○ | 拡散項、圧力勾配 |
| ENO/WENO | △ | 可能だが過剰 |
| Riemann solver | × | 非圧縮では不要 |

### 4.2 スタガード格子でのTVD適用

本ソルバーでは、スタガード格子上でTVDスキームを適用している：

1. **対象**: 移流項の速度勾配 $\partial u/\partial x$, $\partial u/\partial y$ など
2. **方法**: MUSCL型再構築で速度値を再構築し、勾配を計算
3. **リミッター**: 勾配比に基づいて高次精度補正を制限

これにより、スタガード格子のまま移流項の数値拡散を低減できる。

### 4.3 圧縮性スキームとの違い

| 観点 | 圧縮性（コロケート） | 非圧縮性（スタガード） |
|------|------------------|---------------------|
| 適用対象 | 保存変数の再構築 | 速度勾配の再構築 |
| Riemann問題 | 明示的に解く | 不要（非双曲型） |
| 特性速度 | 音速 $c$ を含む | 流速 $u$ のみ |
| 圧力 | 状態方程式から計算 | Poisson方程式で計算 |

---

## 5. 将来の拡張に向けて

### 5.1 圧縮性ソルバーの実装

圧縮性流体のシミュレーションを行う場合は、以下の構成が推奨される：

1. **格子**: コロケート格子
2. **基本方程式**: Euler方程式またはNavier-Stokes方程式（保存形式）
3. **時間積分**: Runge-Kutta法（TVD-RK3など）
4. **空間離散化**:
   - MUSCL + TVDリミッター
   - または WENO5
5. **Riemannソルバー**: HLLCまたはRoe

### 5.2 統一的なフレームワーク

将来的には、非圧縮性と圧縮性を統一的に扱うフレームワークも可能：

- **人工圧縮性法**: 非圧縮性を圧縮性の低マッハ極限として扱う
- **Preconditioned method**: 低マッハ数での数値的問題を回避

---

## 6. まとめ

1. **非圧縮性流体**: スタガード格子が適している（圧力振動抑制、連続の式の正確な離散化）

2. **圧縮性流体**: コロケート格子 + 有限体積法 + 数値流束が標準的

3. **高次精度スキーム**:
   - TVDはスタガード格子でも適用可能（本実装）
   - ENO/WENOは圧縮性ソルバーで真価を発揮

4. **本ソルバーの位置づけ**: 非圧縮性流体に特化したスタガード格子ソルバー。TVDスキームにより数値拡散を低減しつつ、振動を抑制している。

---

## 7. スタガード格子と数値流束の整合性

### 7.1 質問への回答

> 「非圧縮性流体ではスタガード格子が適していて、圧縮性では数値流束を考えるのが適していることが多い」という認識は正しいか？

この認識は**概ね正しい**。ただし、より正確には以下のように整理できる：

| 流体タイプ | 標準的な手法 | 理由 |
|-----------|------------|------|
| **非圧縮性** | スタガード格子 + Projection法 | 連続の式が「拘束条件」であり、圧力がLagrange乗数として作用。チェッカーボード振動の抑制。 |
| **圧縮性** | コロケート格子 + 数値流束 + Riemannソルバー | 方程式が双曲型保存則であり、波動伝播（衝撃波など）を正確に捉える必要がある。 |

### 7.2 なぜ整合性が問題になりうるか

スタガード格子では変数が異なる位置にあるため、「セル境界での数値流束」という概念がコロケート格子ほど自然ではない：

**コロケート格子での数値流束**:
```
   U_i-1      U_i       U_i+1
     |         |          |
     +----F----+----F-----+
        i-1/2     i+1/2
```
→ セル境界 $i+1/2$ での流束 $\hat{F}_{i+1/2}$ を、左右の状態 $U_i, U_{i+1}$ から計算

**スタガード格子での状況**:
```
     u_i-1     p_i      u_i      p_i+1    u_i+1
       |        |        |         |        |
       +--------+--------+---------+--------+
```
→ 速度 $u$ と圧力 $p$ が異なる位置にあり、「Riemann問題」を設定する自然な場所がない

### 7.3 スタガード格子でも数値流束は使える

本ソルバーのTVD実装が示すように、スタガード格子でも高次精度の移流スキームは適用可能である：

1. **移流項の再構築**: 速度値を高次精度で再構築（MUSCL型）
2. **フラックスリミッター**: 勾配比に基づいて高次補正を制限
3. **適用範囲**: 移流項 $\mathbf{u} \cdot \nabla u$ の速度勾配部分

ただし、**Riemannソルバーは不要かつ不適切**：
- 非圧縮性流体は双曲型ではない（音速が無限大）
- 波動伝播ではなく、圧力Poisson方程式による瞬時の情報伝播

### 7.4 圧縮性スキームの転用可能性

ENO/WENOなどの高度なスキームをスタガード格子で使う場合の注意点：

| スキーム | スタガード格子での適用 | 備考 |
|---------|---------------------|------|
| TVD (Minmod, Van Leer等) | ◎ 適用可能 | 本実装で実証済み |
| ENO | △ 可能だが複雑 | ステンシル選択の座標系に注意 |
| WENO | △ 可能だが複雑 | 重み計算の適用位置に注意 |
| Riemann solver | × 不適切 | 非圧縮性では理論的に不要 |

**結論**: 圧縮性で発達したスキーム研究の知見（特にTVDリミッター）は、スタガード格子にも転用可能である。ただし、Riemannソルバーのような「波動特性」に基づく手法は、非圧縮性流体には適さない。

### 7.5 ハイブリッドアプローチ

両者の利点を組み合わせる手法も存在する：

1. **Rhie-Chow補間**: コロケート格子で非圧縮性を扱う際のチェッカーボード振動抑制
2. **人工圧縮性法**: 非圧縮性を圧縮性の低マッハ極限として扱い、圧縮性ソルバーを転用
3. **Preconditioned Euler**: 低マッハ数での数値的問題を回避しつつ、統一的なフレームワークを構築

---

## 8. 圧力のLagrange乗数としての解釈

### 8.1 変分原理との関係

非圧縮性Navier-Stokes方程式において、圧力 $p$ は**連続の式に対するLagrange乗数**として解釈できる。これは変分原理から自然に導かれる：

**制約付き最小化問題**:
$$
\min_{\mathbf{u}} \int \left( \frac{\partial \mathbf{u}}{\partial t} + (\mathbf{u} \cdot \nabla)\mathbf{u} - \nu \nabla^2 \mathbf{u} \right)^2 d\Omega
$$
$$
\text{subject to: } \nabla \cdot \mathbf{u} = 0
$$

Lagrangian:
$$
\mathcal{L} = \int \left[ \ldots - p (\nabla \cdot \mathbf{u}) \right] d\Omega
$$

停留条件 $\delta \mathcal{L} / \delta \mathbf{u} = 0$ から運動量方程式が、$\delta \mathcal{L} / \delta p = 0$ から連続の式が得られる。

### 8.2 物理的意味

この解釈の重要な帰結：

1. **圧力は導出量**: 圧力は速度場に対する拘束条件を満たすために「必要な力」として決まる。状態方程式からではなく、連続の式から決定される。

2. **圧力の一意性**: 連続の式は $\nabla \cdot \mathbf{u} = 0$ という条件だけなので、圧力は定数分の不定性を持つ（絶対値ではなく勾配のみが物理的意味を持つ）。

3. **Projection法との対応**: Projection法のステップ:
   - 予測: 制約なしで速度を更新
   - 圧力計算: 制約を満たすためのLagrange乗数を計算
   - 補正: Lagrange乗数の勾配で速度を修正

### 8.3 連続体力学における一般化

Lagrange乗数としての「圧力」や「応力」は、連続体力学で広く見られる：

| 拘束条件 | Lagrange乗数 | 物理的意味 |
|---------|-------------|-----------|
| 非圧縮性 $\nabla \cdot \mathbf{u} = 0$ | 圧力 $p$ | 体積保存を強制する等方的な力 |
| 非伸張性 | 張力 $T$ | 弦や膜の長さを保存 |
| 剛体拘束 | 拘束力 | 変形を禁止する反力 |

この視点は、数値解法の設計においても重要である。圧力を「波」として伝播させる（圧縮性的アプローチ）のではなく、「拘束条件を満たすための調整パラメータ」として扱う（Projection法的アプローチ）方が、非圧縮性の本質に即している。

---

## 参考文献

- Harlow, F. H., & Welch, J. E. (1965). Numerical calculation of time-dependent viscous incompressible flow. *Physics of Fluids*, 8(12), 2182-2189.
- Rhie, C. M., & Chow, W. L. (1983). Numerical study of the turbulent flow past an airfoil with trailing edge separation. *AIAA Journal*, 21(11), 1525-1532.
- Toro, E. F. (2009). *Riemann Solvers and Numerical Methods for Fluid Dynamics* (3rd ed.). Springer.
- LeVeque, R. J. (2002). *Finite Volume Methods for Hyperbolic Problems*. Cambridge University Press.
